<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=0.80, maximum-scale=0.80, user-scalable=no">
<title>Factores Humanos - Reporte de Incidente</title>
<style>
  :root {
    --primary: #1755f4;
    --primary-hover: #123cbc;
    --bg-body: #f4f7fa;
    --card-bg: #ffffff;
    --text-main: #2d3436;
    --text-muted: #636e72;
    --border-color: #d1d9e6;
    --rojo: #ed1e2e;
    --amarillo: #fbbd2e;
    --verde: #2b9145;
  }

  * { box-sizing: border-box; }
  body {
    background-color: var(--bg-body);
    font-family: 'Segoe UI', sans-serif;
    color: var(--text-main);
    margin: 0;
    padding: 20px;
  }

  .container { max-width: 1200px; margin: 0 auto; }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: white;
    padding: 15px 30px;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    margin-bottom: 25px;
  }
  .logo-placeholder { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
  .title-container { text-align: center; flex-grow: 1; }
  header h1 { font-size: 24px; margin: 0; text-transform: uppercase; letter-spacing: 1px; }
  header h1 span { color: var(--primary); }
  .sub-title {
    font-size: 11px;
    background: var(--primary);
    color: white;
    padding: 4px 12px;
    font-weight: 700;
    border-radius: 20px;
    display: inline-block;
    margin-top: 5px;
  }

  /* Layout de Filas y Columnas */
  .row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
  .col { flex: 1; min-width: 350px; display: flex; flex-direction: column; }

  .card {
    background: white;
    border-radius: 16px;
    padding: 25px;
    height: 100%; /* Para que las tarjetas en la misma fila tengan igual altura */
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    border: 1px solid #e1e8f0;
  }
  
  .section-header {
    font-weight: 700;
    font-size: 14px;
    color: var(--primary);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    text-transform: uppercase;
  }
  .section-header .icon { background: var(--primary); color: white; border-radius: 6px; padding: 4px 8px; }

  label.bold { font-weight: 700; font-size: 11px; color: var(--text-main); margin-bottom: 8px; display: block; text-transform: uppercase; }
  
  input, select, textarea {
    width: 100%; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 14px;
  }

  /* Botones de selección */
  .btn-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
  .btn-opt {
    background: white; border: 1px solid var(--border-color); padding: 10px 12px; border-radius: 10px;
    cursor: pointer; font-size: 11px; font-weight: 700; transition: 0.2s;
  }
  .btn-opt.selected { background: var(--primary); color: white; border-color: var(--primary); }
  .btn-opt.rojo.selected { background: var(--rojo); border-color: var(--rojo); }
  .btn-opt.amarillo.selected { background: var(--amarillo); border-color: var(--amarillo); color: #000; }
  .btn-opt.verde.selected { background: var(--verde); border-color: var(--verde); }

  /* Checkboxes estilizados */
  .check-box-group { display: flex; flex-wrap: wrap; gap: 8px; }
  .check-item { display: none; }
  .check-label {
    border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 8px;
    cursor: pointer; font-size: 11px; font-weight: 600; background: white;
  }
  .check-item:checked + .check-label { background: var(--primary); color: white; border-color: var(--primary); }

  .signature-box { border: 2px dashed var(--primary); border-radius: 12px; width: 100%; height: 160px; background: #fafafa; }

  .actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
  .btn-action { padding: 12px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; color: white; }
  .btn-copy { background: #6c757d; }
  .btn-preview { background: var(--verde); }
  .btn-generate { background: var(--primary); }

  @media (max-width: 850px) { .col { min-width: 100%; } }
</style>
</head>
<body>

<div class="container">
  <header>
    <img src="https://i.imgur.com/EsZiIHa.jpeg" class="logo-placeholder" alt="Logo SAME">
    <div class="title-container">
      <h1>Factores <span>Humanos</span></h1>
      <div class="sub-title">REPORTE DE INCIDENTE - SAME BUENOS AIRES - ARGENTINA</div>
    </div>
    <div style="width:60px"></div>
  </header>

  <!-- FILA 1: DATOS + IDENTIFICACIÓN -->
  <div class="row">
    <div class="col">
      <section class="card">
        <div class="section-header"><div class="icon">1</div> DATOS</div>
        <div class="row" style="gap:10px; margin-bottom:10px;">
            <div style="flex:1">
                <label class="bold">Ámbito de Actuación</label>
                <div class="btn-group" id="ambito-group">
                  <button type="button" class="btn-opt" data-value="POBLACIÓN GENERAL">POBLACIÓN GENERAL</button>
                  <button type="button" class="btn-opt" data-value="PROPIO PERSONAL">PERSONAL</button>
                </div>
            </div>
            <div style="flex:1">
                <label class="bold">Función</label>
                <input type="text" id="funcion">
            </div>
        </div>
        <div class="row" style="gap:10px;">
            <div style="flex:1"><label class="bold">Años</label><input type="number" id="anios"></div>
            <div style="flex:1"><label class="bold">Referente</label><input type="text" id="referente"></div>
        </div>
      </section>
    </div>

    <div class="col">
      <section class="card">
        <div class="section-header"><div class="icon">2</div> IDENTIFICACIÓN</div>
        <label class="bold">Nombre y Apellido </label> 
        <input type="text" id="nombreApellido" placeholder="Ej.: Juan Perez" style="margin-bottom:10px;">
        <div class="row" style="gap:10px;">
          <div style="flex:1"><label class="bold">DNI</label><input type="text" placeholder="Ej.: 12345678" id="dni"></div>
          <div style="flex:1"><label class="bold">Edad</label><input type="number" placeholder="Ej.: 21 años" id="edad"></div>
        </div>
        <div style="margin-top:10px;">
          <label class="bold">Sexo/Género</label>
          <div class="btn-group" id="sexo-group">
            <button type="button" class="btn-opt" data-value="Masculino">MASCULINO</button>
            <button type="button" class="btn-opt" data-value="Femenino">FEMENINO</button>
            <button type="button" class="btn-opt" data-value="OTRO">OTRO</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- SECCIÓN 3: LUGAR (ANCHO COMPLETO) -->
  <section class="card" style="margin-bottom:20px;">
    <div class="section-header"><div class="icon">3</div> LUGAR / UBICACIÓN</div>
    <div class="row">
      <div class="col"><label class="bold">Fecha</label><input type="date" id="fecha"></div>
      <div class="col"><label class="bold">Hora</label><input type="time" id="hora"></div>
      <div class="col">
        <label class="bold">Categoría</label>
        <select id="categoria">
          <option value="">Seleccione...</option>
          <option value="Domicilio">Domicilio</option>
          <option value="Vía Pública">Vía Pública</option>
          <option value="Hospital / Centro Salud">Hospital / Centro Salud</option>
          <option value="Incendio">Incendio</option>
          <option value="Choque Vehicular">Choque Vehicular</option>
          <option value="Derrumbe">Derrumbe</option>
          <option value="Otros">Otros</option>
        </select>
        <input type="text" id="categoria_otros" placeholder="Especifique..." style="display:none; margin-top:10px">
      </div>
    </div>
    <div class="row" style="margin-top:15px;">
      <div class="col" style="flex: 2;">
        <label class="bold"></label>
        <div class="check-box-group">
          <input type="checkbox" id="c1" class="check-item" name="acompa" value="En compañía del chofer"><label for="c1" class="check-label">En compañía del chofer</label>
          <input type="checkbox" id="c2" class="check-item" name="acompa" value="En compañía de equipo"><label for="c2" class="check-label">En compañía de equipo</label>
          <input type="checkbox" id="c3" class="check-item" name="acompa" value="Jefe de guardia Dr."><label for="c3" class="check-label">Jefe de guardia Dr.</label>
        </div>
      </div>
      <div class="col">
        <label class="bold">AGRESORID</label>
        <div class="check-box-group">
          <input type="radio" id="a1" name="agresor" class="check-item" value="Si"><label for="a1" class="check-label">Si</label>
          <input type="radio" id="a2" name="agresor" class="check-item" value="No"><label for="a2" class="check-label">No</label>
        </div>
      </div>
    </div>
    <div style="margin-top:15px"><label class="bold">Dirección Exacta</label><input type="text" placeholder="Ej.: Avenida Córdoba 2102" id="direccion"></div>
  </section>

  <!-- SECCIÓN 4: VALORACIÓN (ANCHO COMPLETO) -->
  <section class="card" style="margin-bottom:20px;">
    <div class="section-header"><div class="icon">4</div> VALORACIÓN CLÍNICA (TRIAGE)</div>
    <div class="btn-group">
      <button type="button" class="btn-opt rojo" data-triage="rojo">ROJO</button>
      <button type="button" class="btn-opt amarillo" data-triage="amarillo">AMARILLO</button>
      <button type="button" class="btn-opt verde" data-triage="verde">VERDE</button>
    </div>
    <div id="manifestaciones-container"></div>
    <div style="margin-top:15px">
      <label class="bold">TRIAGE PSICOLÓGICO PREHOSPITALARIO</label>
      <textarea id="cronica" rows="10"></textarea>
    </div>
  </section>

  <!-- FILA 2: PRESTACIÓN + PROSECUCIÓN -->
  <div class="row">
    <div class="col">
      <section class="card">
        <div class="section-header"><div class="icon">5</div> PRESTACIÓN</div>
        <label class="bold">Duración</label>
        <input type="text" id="duracion" placeholder="Ej: 45 min" style="margin-bottom:15px;">
        <label class="bold">Tipo de Entrevista</label>
        <div class="check-box-group" style="margin-bottom:15px;">
          <input type="radio" name="tipo_ent" id="te1" class="check-item" value="Entrevista individual"><label for="te1" class="check-label">Individual</label>
          <input type="radio" name="tipo_ent" id="te2" class="check-item" value="Entrevista grupal"><label for="te2" class="check-label">Grupal</label>
        </div>
        <label class="bold">Servicios Complementarios</label>
        <div class="check-box-group">
          <input type="checkbox" name="serv" id="s1" class="check-item" value="Contacto Telefónico"><label for="s1" class="check-label">Contacto Telefónico</label>
          <input type="checkbox" name="serv" id="s2" class="check-item" value="Seguimiento"><label for="s2" class="check-label">Seguimiento</label>
          <input type="checkbox" name="serv" id="s3" class="check-item" value="Datos Estrés Traumático"><label for="s3" class="check-label">Datos Estrés Traumático</label>
        </div>
      </section>
    </div>

    <div class="col">
      <section class="card">
        <div class="section-header"><div class="icon">6</div> PROSECUCIÓN</div>
        <label class="bold">Derivación</label>
        <input type="text" id="deriva_comentario" placeholder="Ej.: Hospital" style="margin-bottom:15px;">
        <label class="bold"></label>
        <div class="check-box-group">
          <input type="checkbox" name="deriva" id="d1" class="check-item" value="Psicoterapia"><label for="d1" class="check-label">Psicoterapia</label>
          <input type="checkbox" name="deriva" id="d2" class="check-item" value="Psiquiatria"><label for="d2" class="check-label">Psiquiatria</label>
          <input type="checkbox" name="deriva" id="d3" class="check-item" value="Internación"><label for="d3" class="check-label">Internación</label>
          <input type="checkbox" name="deriva" id="d4" class="check-item" value="Otro"><label for="d4" class="check-label">Otro</label>
        </div>
        <input type="text" id="deriva_otro" placeholder="Especifique otro..." style="display:none; margin-top:10px">
      </section>
    </div>
  </div>

  <!-- FILA 3: SEGUIMIENTOS + FIRMA -->
  <div class="row">
    <div class="col">
      <section class="card">
        <div class="section-header"><div class="icon">7</div> SEGUIMIENTOS POSTINCIDENTE</div>
        <div class="check-box-group" style="margin-bottom:15px;">
          <input type="checkbox" id="seg_primera" class="check-item" value="PRIMERA VEZ"><label for="seg_primera" class="check-label">PRIMERA VEZ</label>
          <input type="checkbox" id="seg_ulteriores" class="check-item" value="ULTERIORES"><label for="seg_ulteriores" class="check-label">ULTERIORES</label>
        </div>
        <div id="ulteriores-box" style="display:none; margin-bottom:15px; padding:10px; background:#f8f9fa; border-radius:10px">
          <div class="check-box-group">
            <input type="checkbox" name="ult_op" id="u1" class="check-item" value="1 SEMANA"><label for="u1" class="check-label">1 SEMANA</label>
            <input type="checkbox" name="ult_op" id="u2" class="check-item" value="1 MES"><label for="u2" class="check-label">1 MES</label>
            <input type="checkbox" name="ult_op" id="u3" class="check-item" value="3 MESES"><label for="u3" class="check-label">3 MESES</label>
            <input type="checkbox" name="ult_op" id="u4" class="check-item" value="OTRO"><label for="u4" class="check-label">OTRO</label>
          </div>
          <input type="text" id="ult_otro" placeholder="Especifique..." style="display:none; margin-top:10px">
        </div>
        <label class="bold">Observaciones</label>
        <textarea id="observaciones" rows="3"></textarea>
      </section>
    </div>

    <div class="col">
      <section class="card">
        <div class="section-header"><div class="icon">8</div> FIRMA</div>
        <canvas id="signature" class="signature-box"></canvas>
        <button type="button" id="clear-sig" style="margin-top:10px; border:none; background:none; color:var(--rojo); cursor:pointer; font-weight:700; font-size:11px;">LIMPIAR FIRMA</button>
      </section>
    </div>
  </div>

  <!-- BOTONES DE ACCIÓN -->
  <div class="actions">
    <button class="btn-action btn-copy" id="btn-copy">COPIAR TEXTO</button>
    <button class="btn-action btn-preview" id="btn-preview">VISTA PREVIA PDF</button>
    <button class="btn-action btn-generate" id="btn-download">GENERAR PDF</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  const state = {
    triage: new Set(),
    manifestaciones: { rojo: new Set(), amarillo: new Set(), verde: new Set() },
    ambito: '',
    sexo: ''
  };

  const manifData = {
    rojo: ["Disociación", "Excitación Psicomotriz", "Intencionalidad Suicida", "Alteraciones sesoperceptivas", "Ideación delirante", "Otra"],
    amarillo: ["Amnesia", "Reexperimentación psico y/o somatoforme", "Reacciones panicosas", "Otra"],
    verde: ["Reacciones de tristeza/irritabilidad", "Emociones secundarias", "Negación", "Personalización Tipo 1", "Personalización Tipo 2", "Otra"]
  };

  document.addEventListener('DOMContentLoaded', () => {
    initButtons();
    initTriage();
    initSignature();
    initLogic();
    generarCronica();
  });

  function initButtons() {
    ['ambito-group', 'sexo-group'].forEach(id => {
      const container = document.getElementById(id);
      container.addEventListener('click', e => {
        if(e.target.tagName === 'BUTTON') {
          container.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
          e.target.classList.add('selected');
          if(id === 'ambito-group') state.ambito = e.target.dataset.value;
          if(id === 'sexo-group') state.sexo = e.target.dataset.value;
          generarCronica();
        }
      });
    });
  }

  function initTriage() {
    document.querySelectorAll('[data-triage]').forEach(btn => {
      btn.onclick = () => {
        const color = btn.dataset.triage;
        state.triage.has(color) ? state.triage.delete(color) : state.triage.add(color);
        btn.classList.toggle('selected');
        renderManifestaciones();
        generarCronica();
      };
    });
  }

  function renderManifestaciones() {
    const container = document.getElementById('manifestaciones-container');
    container.innerHTML = '';
    state.triage.forEach(color => {
      const box = document.createElement('div');
      box.style.marginTop = '15px';
      box.innerHTML = `<label class="bold" style="color:var(--${color})">Manifestación ${color.toUpperCase()}:</label>`;
      const group = document.createElement('div');
      group.className = 'check-box-group';
      manifData[color].forEach(m => {
        const id = `m-${color}-${m.replace(/ /g,'')}`;
        group.innerHTML += `<input type="checkbox" id="${id}" class="check-item" ${state.manifestaciones[color].has(m)?'checked':''} onchange="toggleManif('${color}', '${m}', this)"><label for="${id}" class="check-label">${m}</label>`;
      });
      box.appendChild(group);
      const inputOtra = document.createElement('input');
      inputOtra.id = `otra-${color}`;
      inputOtra.placeholder = "Especifique otra...";
      inputOtra.style.display = state.manifestaciones[color].has('Otra') ? 'block' : 'none';
      inputOtra.style.marginTop = '10px';
      inputOtra.oninput = generarCronica;
      box.appendChild(inputOtra);
      container.appendChild(box);
    });
  }

  window.toggleManif = (color, m, el) => {
    el.checked ? state.manifestaciones[color].add(m) : state.manifestaciones[color].delete(m);
    if(m === 'Otra') document.getElementById(`otra-${color}`).style.display = el.checked ? 'block' : 'none';
    generarCronica();
  };

  function initLogic() {
    document.getElementById('categoria').onchange = (e) => {
      document.getElementById('categoria_otros').style.display = e.target.value === 'Otros' ? 'block' : 'none';
      generarCronica();
    };
    document.getElementById('d4').onchange = (e) => {
        document.getElementById('deriva_otro').style.display = e.target.checked ? 'block' : 'none';
        generarCronica();
    };
    document.getElementById('seg_ulteriores').onchange = (e) => {
        document.getElementById('ulteriores-box').style.display = e.target.checked ? 'block' : 'none';
        generarCronica();
    };
    document.getElementById('u4').onchange = (e) => {
        document.getElementById('ult_otro').style.display = e.target.checked ? 'block' : 'none';
        generarCronica();
    };
    document.querySelectorAll('input, textarea, select').forEach(el => {
        if(el.id !== 'cronica') el.addEventListener('input', generarCronica);
    });
  }

  function generarCronica() {
    const val = id => document.getElementById(id)?.value || '';
    const nombre = val('nombreApellido') || '_____';
    const edad = val('edad') || '___';
    const dni = val('dni') || '_______';
    const sexo = state.sexo || '_____';
    
    let texto = `${nombre}, ${edad} años, de sexo/género ${sexo}, DNI: ${dni}\n\n`;
    texto += `ÁMBITO: ${state.ambito || '---'}\n`;
    texto += `FUNCIÓN: ${val('funcion') || '---'} | AÑOS: ${val('anios') || '---'}\n`;
    texto += `REFERENTE: ${val('referente') || '---'}\n\n`;
 
   let acompaArr = [];
    document.querySelectorAll('[name="acompa"]:checked').forEach(c => acompaArr.push(c.value));
    texto += `Categoria: ${val('categoria')} ${val('categoria')==='Otros'?'('+val('categoria_otros')+')':''} | Acompañamiento: ${acompaArr.join(', ') || 'Solo'}\n`;
    texto += `AGRESORID: ${document.querySelector('[name="agresor"]:checked')?.value || 'No'}\n\n`;

    texto += `VALORACIÓN CLÍNICA (TRIAGE): ${Array.from(state.triage).join(', ').toUpperCase() || '---'}\n`;
    state.triage.forEach(color => {
      const mArr = Array.from(state.manifestaciones[color]);
      texto += `- ${color.toUpperCase()}: ${mArr.join(', ')}`;
      if(mArr.includes('Otra')) texto += ` (${val('otra-'+color)})`;
      texto += `\n`;
    });

    texto += `\n--- PRESTACIÓN ---\n`;
    texto += `Duración: ${val('duracion') || '---'}\n`;
    texto += `Tipo de Entrevista: ${document.querySelector('[name="tipo_ent"]:checked')?.value || '---'}\n`;
    let servs = [];
    document.querySelectorAll('[name="serv"]:checked').forEach(s => servs.push(s.value));
    texto += `Servicios: ${servs.join(', ') || 'Ninguno'}\n`;

    texto += `\n--- PROSECUCIÓN ---\n`;
    texto += `Comentarios: ${val('deriva_comentario') || 'Sin comentarios'}\n`;
    let ders = [];
    document.querySelectorAll('[name="deriva"]:checked').forEach(d => ders.push(d.value));
    texto += `Derivaciones: ${ders.join(', ') || 'Ninguna'}`;
    if(ders.includes('Otro')) texto += ` (${val('deriva_otro')})`;
    texto += `\n`;

    texto += `\n--- SEGUIMIENTOS POSTINCIDENTE ---\n`;
    let segs = [];
    if(document.getElementById('seg_primera').checked) segs.push("PRIMERA VEZ");
    if(document.getElementById('seg_ulteriores').checked) {
        let ults = [];
        document.querySelectorAll('[name="ult_op"]:checked').forEach(u => ults.push(u.value));
        segs.push(`ULTERIORES (${ults.join(', ')}${ults.includes('OTRO')?': '+val('ult_otro'):''})`);
    }
    texto += `Estado: ${segs.join(' / ') || 'No especificado'}\n`;
    texto += `Observaciones: ${val('observaciones') || 'Sin observaciones'}`;

    document.getElementById('cronica').value = texto;
  }

  // FIRMA
  let canvas, ctx, drawing = false;
  function initSignature() {
    canvas = document.getElementById('signature');
    ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    const getPos = e => {
      const rect = canvas.getBoundingClientRect();
      const clientX = e.clientX || e.touches[0].clientX;
      const clientY = e.clientY || e.touches[0].clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    };
    const start = e => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); };
    const move = e => { if(!drawing) return; if(e.touches) e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
    const stop = () => drawing = false;

    canvas.onmousedown = start; canvas.onmousemove = move; canvas.onmouseup = stop;
    canvas.ontouchstart = start; canvas.ontouchmove = move; canvas.ontouchend = stop;
    document.getElementById('clear-sig').onclick = () => ctx.clearRect(0,0,canvas.width,canvas.height);
  }

  document.getElementById('btn-copy').onclick = () => {
    navigator.clipboard.writeText(document.getElementById('cronica').value);
    alert('Texto copiado!');
  };

  async function createPDF() {
    const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });
  const pageWidth = doc.internal.pageSize.width;
  const pageHeight = doc.internal.pageSize.height;
  const margin = 40;
  let y = 40;

  const colorPrimario = [23, 85, 244]; 
  const colorFondoCaja = [238, 244, 255]; 
  const colorTextoGris = [120, 130, 140];
  const colorTextoNegro = [0, 0, 0];

  async function loadImage(url) {
    return new Promise((resolve) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        resolve(canvas.toDataURL("image/png"));
      };
      img.src = url;
    });
  }

  const logoBase64 = await loadImage("https://i.imgur.com/EsZiIHa.jpeg");

  // --- HEADER ---
  doc.addImage(logoBase64, "PNG", margin, y - 5, 45, 45);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(24);
  doc.setTextColor(45, 52, 54);
  doc.text("Factores", margin + 55, y + 18);
  doc.setTextColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
  doc.text("Humanos", margin + 155, y + 18);

  y += 28;
  const subTitle = "REPORTE DE INCIDENTE - SAME Buenos Aires - Argentina";
  doc.setFontSize(9);
  const subW = doc.getTextWidth(subTitle) + 20;
  doc.setFillColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
  doc.roundedRect(margin + 55, y, subW, 16, 4, 4, "F");
  doc.setTextColor(255, 255, 255);
  doc.text(subTitle, margin + 65, y + 11);

  y += 50;

  // --- DATOS ---
  doc.setFontSize(10);
  doc.setTextColor(150);
  doc.text("DATOS", margin, y);
  y += 10;
  doc.setFillColor(colorFondoCaja[0], colorFondoCaja[1], colorFondoCaja[2]);
  doc.roundedRect(margin, y, pageWidth - (margin * 2), 45, 12, 12, "F");

  const colW = (pageWidth - (margin * 2)) / 4;
  const etiquetasDatos = ["ÁMBITO DE ACTUACIÓN", "FUNCIÓN", "AÑOS", "REFERENTE"];
  const valoresDatos = [state.ambito || "---", document.getElementById('funcion').value || "---", document.getElementById('anios').value || "---", document.getElementById('referente').value || "---"];

  etiquetasDatos.forEach((et, i) => {
    doc.setFontSize(7);
    doc.setTextColor(150);
    doc.text(et, margin + (colW * i) + 15, y + 18);
    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(0);
    doc.text(String(valoresDatos[i]).toUpperCase(), margin + (colW * i) + 15, y + 32);
  });

  y += 65;

  // --- IDENTIFICACIÓN Y ESCENARIO ---
  const boxW = (pageWidth - (margin * 2) - 15) / 2;
  const boxH = 90;

  // Caja Identificación
  doc.setFillColor(colorFondoCaja[0], colorFondoCaja[1], colorFondoCaja[2]);
  doc.roundedRect(margin, y, boxW, boxH, 12, 12, "F");
  doc.setFontSize(8);
  doc.setFont("helvetica", "bold"); // Título en Negrita
  doc.setTextColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
  doc.text("IDENTIFICACIÓN DEL PACIENTE", margin + 15, y + 18);
  doc.setDrawColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
  doc.line(margin + 15, y + 23, margin + boxW - 15, y + 23);

  doc.setFontSize(14);
  doc.setTextColor(0);
  doc.text((document.getElementById('nombreApellido').value || "SIN NOMBRE").toUpperCase(), margin + 15, y + 45);

  doc.setFontSize(8);
  doc.setFont("helvetica", "normal");
  doc.setTextColor(colorTextoGris[0], colorTextoGris[1], colorTextoGris[2]);
  // MEJORA: Más espacio entre DNI, Edad y Sexo
  doc.text(`DNI: ${document.getElementById('dni').value || "---"}`, margin + 15, y + 65);
  doc.text(`EDAD: ${document.getElementById('edad').value || "--"}`, margin + 100, y + 65);
  doc.text(`SEXO: ${state.sexo || "-"}`, margin + 175, y + 65);

  // Caja Escenario
  doc.setFillColor(colorFondoCaja[0], colorFondoCaja[1], colorFondoCaja[2]);
  doc.roundedRect(margin + boxW + 15, y, boxW, boxH, 12, 12, "F");
  doc.setFontSize(8);
  doc.setFont("helvetica", "bold"); // Título en Negrita
  doc.setTextColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
  doc.text("DATOS DEL ESCENARIO", margin + boxW + 30, y + 18);
  doc.line(margin + boxW + 30, y + 23, margin + (boxW * 2) + 15 - 15, y + 23);

  // MEJORA: Dirección en Negrita y Grande
  const direccion = document.getElementById('direccion').value || "No especificada";
  doc.setFontSize(13);
  doc.setFont("helvetica", "bold");
  doc.setTextColor(0);
  const dirLines = doc.splitTextToSize(direccion.toUpperCase(), boxW - 45);
  doc.text(dirLines, margin + boxW + 30, y + 42);

  doc.setFontSize(8);
  doc.setFont("helvetica", "normal");
  doc.setTextColor(colorTextoGris[0], colorTextoGris[1], colorTextoGris[2]);
  doc.text(`FECHA: ${document.getElementById('fecha').value || "---"}`, margin + boxW + 30, y + 65);
  doc.text(`HORA: ${document.getElementById('hora').value || "---"}`, margin + boxW + 140, y + 65);

  y += boxH + 30;

  // --- TRIAGE COLOREADO ---
  let colorTriage = [210, 220, 230]; // Gris por defecto
  let textoTriage = Array.from(state.triage).join(" / ").toUpperCase() || "PENDIENTE";
  
  // Lógica de colores según selección
  if(state.triage.has('rojo')) colorTriage = [237, 30, 46];
  else if(state.triage.has('amarillo')) colorTriage = [251, 189, 46];
  else if(state.triage.has('verde')) colorTriage = [43, 145, 69];

  doc.setFillColor(colorTriage[0], colorTriage[1], colorTriage[2]);
  doc.roundedRect(margin, y, 120, 18, 9, 9, "F");
  doc.setFont("helvetica", "bold");
  doc.setFontSize(8);
  doc.setTextColor(state.triage.has('amarillo') ? 0 : 255); // Texto negro si es amarillo para contraste
  doc.text(`TRIAGE: ${textoTriage}`, margin + 10, y + 12);

  y += 35;

  // --- CRÓNICA ---
  doc.setFontSize(9);
  doc.setTextColor(150);
  doc.text("DESCRIPCIÓN DEL INCIDENTE", margin, y);
  y += 15;
  doc.setFont("helvetica", "normal");
  doc.setTextColor(0);
  const cronicaLines = doc.splitTextToSize(document.getElementById('cronica').value, pageWidth - (margin * 2));
  doc.text(cronicaLines, margin, y);

  // --- FIRMA ---
  const sigX = pageWidth - margin - 180;
  const sigY = pageHeight - margin - 90 - 20;
  doc.setDrawColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
  doc.roundedRect(sigX, sigY, 180, 90, 15, 15, "S");
  doc.addImage(canvas.toDataURL("image/png"), "PNG", sigX + 10, sigY + 10, 160, 60);
  doc.setFontSize(8);
  doc.setTextColor(150);
  doc.text("FIRMA", sigX + 90, sigY + 80, { align: "center" });

  return doc;
}

// Corregir también la apertura de Vista Previa para que sea más compatible
document.getElementById('btn-preview').onclick = async () => {
    const doc = await generarContenidoPDF();
    const blob = doc.output('blob');
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
};

  document.getElementById('btn-preview').onclick = async () => {
    const doc = await createPDF();
    window.open(doc.output('bloburl'), '_blank');
  };

  document.getElementById('btn-download').onclick = async () => {
    const doc = await createPDF();
    doc.save("Reporte_SAME_FH.pdf");
  };
</script>
</body>
</html>
